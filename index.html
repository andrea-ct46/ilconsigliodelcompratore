<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Il Consiglio del Compratore</title>
  <style>
    body { font-family: system-ui, sans-serif; background:#fafafa; margin:0; }
    .wrap { max-width:1100px; margin:0 auto; padding:32px 16px; }
    h1 { text-align:center; margin-bottom:6px; }
    p.sub { text-align:center; color:#555; margin-top:0; margin-bottom:24px; }
    .grid { display:grid; gap:18px; grid-template-columns:1fr; }
    @media(min-width:768px){ .grid{ grid-template-columns:repeat(3,1fr);} }
    .card{
      background:#fff;
      border:1px solid #ddd;
      border-radius:14px;
      padding:14px;
      box-shadow:0 4px 10px rgba(0,0,0,0.04);
      text-align:center;
    }
    .card img{
      width:100%;
      height:150px;
      object-fit:cover;
      border-radius:10px;
    }
    .btn{
      background:#0066c0;
      color:#fff;
      padding:7px 14px;
      border-radius:8px;
      text-decoration:none;
      display:inline-block;
      margin-top:8px;
      font-size:0.9em;
    }
    .error { text-align:center; color:#c00; margin-top:20px; }
    .debug { font-size:0.8em; color:#777; text-align:center; margin-top:10px; white-space:pre-wrap; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Il Consiglio del Compratore</h1>
    <p class="sub">Prodotti caricati dal mio foglio Google in automatico.</p>
    <div id="prodotti" class="grid"></div>
    <div id="errore" class="error"></div>
    <div id="debug" class="debug"></div>
  </div>

  <script>
    // CSV pubblico del tuo foglio (NON toccare se non cambia il link)
    const RAW_SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTZ7vqus97NYfJoXjHjjI6705eGKxtqWSUWiHI5vT-xPNNghy3Ie2IaQ2MQDZI53Q7dEYzPVHbeIGR9/pub?output=csv";
    const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTZ7vqus97NYfJoXjHjjI6705eGKxtqWSUWiHI5vT-xPNNghy3Ie2IaQ2MQDZI53Q7dEYzPVHbeIGR9/pub?output=csv=" 
  + encodeURIComponent(RAW_SHEET_URL) 
  + "&t=" + Date.now();

    async function caricaProdotti() {
      const errBox = document.getElementById("errore");
      const container = document.getElementById("prodotti");
      const debugBox = document.getElementById("debug");

      try {
        const res = await fetch(CSV_URL);
        if (!res.ok) throw new Error("Fetch fallita: " + res.status);
        const text = await res.text();

        // Debug: mostra le prime righe del CSV (cos√¨ sappiamo che arriva)
        const righeRaw = text.trim().split(/\r?\n/);
        debugBox.textContent = "Righe CSV: " + righeRaw.length;

        if (righeRaw.length <= 1) {
          errBox.textContent = "Nessun prodotto nel foglio. Aggiungi righe sotto le intestazioni.";
          return;
        }

        // Determina il separatore (virgola o punto e virgola)
        const headerLine = righeRaw.shift();
        const delimiter = headerLine.includes(";") ? ";" : ",";
        const rawHeaders = headerLine.split(delimiter);
        const headers = rawHeaders.map(h => h.trim().toLowerCase());

        const idxNome = headers.indexOf("nome");
        const idxDesc = headers.indexOf("descrizione");
        const idxImg  = headers.indexOf("immagine");
        const idxLink = headers.indexOf("link");

        if (idxNome < 0 || idxLink < 0) {
          errBox.textContent = "Intestazioni errate. Devono essere: nome, descrizione, immagine, link.";
          debugBox.textContent += "\\nHeader letti: " + headers.join(" | ");
          return;
        }

        container.innerHTML = "";
        let count = 0;

        righeRaw.forEach(riga => {
          if (!riga.trim()) return;
          const cols = riga.split(delimiter);

          const nome = (cols[idxNome] || "").trim();
          const desc = (cols[idxDesc] || "").trim();
          const img  = (cols[idxImg]  || "").trim();
          const link = (cols[idxLink] || "").trim();

          if (!nome || !link) return;

          const card = document.createElement("div");
          card.className = "card";
          card.innerHTML = `
            ${img ? `<img src="${img}" alt="${nome}">` : ""}
            <h3>${nome}</h3>
            <p>${desc || ""}</p>
            <a class="btn" href="${link}" target="_blank">Vedi su Amazon</a>
          `;
          container.appendChild(card);
          count++;
        });

        if (count === 0) {
          errBox.textContent = "Nessun prodotto valido generato. Controlla che ogni riga abbia almeno nome e link.";
        } else {
          debugBox.textContent += "\\nProdotti generati: " + count;
        }
      } catch (e) {
        console.error(e);
        document.getElementById("errore").textContent =
          "Errore nel caricare i prodotti. Controlla link del foglio o riprova.";
      }
    }

    caricaProdotti();
  </script>
</body>
</html>
