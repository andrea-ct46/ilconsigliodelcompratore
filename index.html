<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Il Consiglio del Compratore</title>
  <style>
    body { font-family: system-ui, sans-serif; background:#fafafa; margin:0; }
    .wrap { max-width:1100px; margin:0 auto; padding:32px 16px; }
    h1 { text-align:center; margin-bottom:6px; }
    p.sub { text-align:center; color:#555; margin-top:0; margin-bottom:24px; }
    .grid { display:grid; gap:18px; grid-template-columns:1fr; }
    @media(min-width:768px){ .grid{ grid-template-columns:repeat(3,1fr);} }
    .card{
      background:#fff;
      border:1px solid #ddd;
      border-radius:14px;
      padding:14px;
      box-shadow:0 4px 10px rgba(0,0,0,0.04);
      text-align:center;
    }
    .card img{
      width:100%;
      height:150px;
      object-fit:cover;
      border-radius:10px;
    }
    .btn{
      background:#0066c0;
      color:#fff;
      padding:7px 14px;
      border-radius:8px;
      text-decoration:none;
      display:inline-block;
      margin-top:8px;
      font-size:0.9em;
    }
    .error { text-align:center; color:#c00; margin-top:20px; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Il Consiglio del Compratore</h1>
    <p class="sub">Prodotti aggiornati dal mio foglio Google in automatico.</p>
    <div id="prodotti" class="grid"></div>
    <div id="errore" class="error"></div>
  </div>

  <script>
    const CSV_URL = "https://api.allorigins.win/raw?url=" + encodeURIComponent(
      "https://docs.google.com/spreadsheets/d/e/2PACX-1vTZ7vqus97NYfJoXjHjjI6705eGKxtqWSUWiHI5vT-xPNNghy3Ie2IaQ2MQDZI53Q7dEYzPVHbeIGR9/pub?output=csv"
    );

    async function caricaProdotti() {
      const errBox = document.getElementById("errore");
      const container = document.getElementById("prodotti");
      try {
        const res = await fetch(CSV_URL);
        if (!res.ok) throw new Error("Fetch fallita: " + res.status);
        const text = await res.text();

        const righe = text.trim().split("\n");
        if (righe.length <= 1) {
          errBox.textContent = "Nessun prodotto trovato nel foglio (controlla che ci siano righe sotto le intestazioni).";
          return;
        }

        const header = righe.shift().split(",");
        const idxNome = header.indexOf("nome");
        const idxDesc = header.indexOf("descrizione");
        const idxImg  = header.indexOf("immagine");
        const idxLink = header.indexOf("link");

        if (idxNome < 0 || idxLink < 0) {
          errBox.textContent = "Intestazioni errate. Devono essere: nome, descrizione, immagine, link.";
          return;
        }

        container.innerHTML = "";
        righe.forEach(riga => {
          if (!riga.trim()) return;
          const cols = riga.split(",");

          const nome = (cols[idxNome] || "").trim();
          const desc = (cols[idxDesc] || "").trim();
          const img  = (cols[idxImg]  || "").trim();
          const link = (cols[idxLink] || "").trim();

          if (!nome || !link) return;

          const card = document.createElement("div");
          card.className = "card";
          card.innerHTML = `
            ${img ? `<img src="${img}" alt="${nome}">` : ""}
            <h3>${nome}</h3>
            <p>${desc || ""}</p>
            <a class="btn" href="${link}" target="_blank">Vedi su Amazon</a>
          `;
          container.appendChild(card);
        });

        if (!container.innerHTML) {
          errBox.textContent = "Nessun prodotto valido generato. Controlla che ogni riga abbia almeno nome e link.";
        }
      } catch (e) {
        console.error(e);
        errBox.textContent = "Errore nel caricare i prodotti. Controlla link del foglio o riprova.";
      }
    }

    caricaProdotti();
  </script>
</body>
</html>