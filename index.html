<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Il Consiglio del Compratore</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <header class="icc-header">
    <div class="icc-header-inner">
      <h1 class="icc-title">Il Consiglio del Compratore</h1>
      <p class="icc-subtitle">
        Prodotti selezionati dal mio foglio Google, aggiornati in automatico.
      </p>
    </div>
  </header>

  <main class="icc-main">
    <!-- FILTRI -->
    <section class="icc-filters">
      <div class="icc-filters-left">
        <div class="icc-filter">
          <label for="search">Cerca</label>
          <input id="search" type="text" placeholder="Cerca per nome..." />
        </div>

        <div class="icc-filter">
          <label for="filter-category">Categoria</label>
          <select id="filter-category">
            <option value="">Tutte le categorie</option>
          </select>
        </div>
      </div>

      <div class="icc-filters-right">
        <div class="icc-filter">
          <label for="price-min">Prezzo min (â‚¬)</label>
          <input id="price-min" type="number" min="0" step="0.01" />
        </div>

        <div class="icc-filter">
          <label for="price-max">Prezzo max (â‚¬)</label>
          <input id="price-max" type="number" min="0" step="0.01" />
        </div>

        <button id="btn-apply" class="icc-btn primary">Applica filtri</button>
        <button id="btn-reset" class="icc-btn ghost">Reset</button>
      </div>
    </section>

    <!-- STATO / ERRORI -->
    <p id="icc-status" class="icc-status"></p>
    <p id="icc-error" class="icc-error"></p>

    <!-- GRIGLIA PRODOTTI -->
    <section id="product-grid" class="icc-grid"></section>
  </main>

  <footer class="icc-footer">
    <p>Â© <span id="icc-year"></span> Il Consiglio del Compratore Â· Link affiliati Amazon</p>
  </footer>

  <script>
    // ðŸ”— 1) METTI QUI IL TUO LINK CSV PUBBLICATO (File â†’ Pubblica sul web â†’ CSV)
    const SHEET_CSV_URL =
      "https://docs.google.com/spreadsheets/d/e/2PACX-1vTZ7vqus97NYfJoXjHjjI6705eGKxtqWSUWiHI5vT-xPNNghy3Ie2IaQ2MQDZI53Q7dEYzPVHbeIGR9/pub?output=csv";

    // Array prodotti caricato dal CSV
    let prodotti = [];

    document.addEventListener("DOMContentLoaded", () => {
      document.getElementById("icc-year").textContent = new Date().getFullYear();
      caricaProdotti();
      setupFiltri();
    });

    function setupFiltri() {
      document.getElementById("btn-apply").addEventListener("click", renderFiltrato);
      document.getElementById("btn-reset").addEventListener("click", () => {
        document.getElementById("search").value = "";
        document.getElementById("filter-category").value = "";
        document.getElementById("price-min").value = "";
        document.getElementById("price-max").value = "";
        renderProdotti(prodotti);
      });
    }

    async function caricaProdotti() {
      const status = document.getElementById("icc-status");
      const errorBox = document.getElementById("icc-error");
      const grid = document.getElementById("product-grid");

      status.textContent = "Caricamento prodotti in corso...";
      errorBox.textContent = "";
      grid.innerHTML = "";

      try {
        const url = SHEET_CSV_URL + (SHEET_CSV_URL.includes("?") ? "&" : "?") + "t=" + Date.now();
        const res = await fetch(url);

        if (!res.ok) {
          throw new Error("HTTP " + res.status);
        }

        const text = await res.text();
        const rows = parseCsv(text);
        if (rows.length <= 1) {
          status.textContent = "Nessun prodotto nel foglio.";
          return;
        }

        const headers = rows.shift().map(h => h.trim().toLowerCase());
        const idxTitle = headers.indexOf("titolo");
        const idxDesc = headers.indexOf("descrizione");
        const idxImg = headers.indexOf("immagine");
        const idxLink = headers.indexOf("link");
        const idxCat = headers.indexOf("categoria");
        const idxPrice = headers.indexOf("prezzo");

        if (idxTitle === -1 || idxLink === -1) {
          throw new Error(
            "Intestazioni mancanti. Servono almeno: titolo, link (piÃ¹ opzionali: descrizione, immagine, categoria, prezzo)."
          );
        }

        prodotti = rows.map(cols => {
          const titolo = (cols[idxTitle] || "").trim();
          const descrizione = idxDesc >= 0 ? (cols[idxDesc] || "").trim() : "";
          const immagine = idxImg >= 0 ? (cols[idxImg] || "").trim() : "";
          const link = (cols[idxLink] || "").trim();
          const categoria = idxCat >= 0 ? (cols[idxCat] || "").trim() : "";
          const prezzoRaw = idxPrice >= 0 ? (cols[idxPrice] || "").trim() : "";
          let prezzo = parseFloat(prezzoRaw.replace(",", "."));
          if (isNaN(prezzo)) prezzo = null;

          return { titolo, descrizione, immagine, link, categoria, prezzo };
        }).filter(p => p.titolo && p.link);

        if (!prodotti.length) {
          status.textContent = "Nessun prodotto valido trovato.";
          return;
        }

        popolaCategorie(prodotti);
        renderProdotti(prodotti);
        status.textContent = `Prodotti caricati: ${prodotti.length}`;
      } catch (err) {
        console.error(err);
        status.textContent = "";
        errorBox.textContent =
          "Errore durante il caricamento del CSV. Controlla l'URL pubblicato o riprova.";
      }
    }

    function popolaCategorie(prodotti) {
      const select = document.getElementById("filter-category");
      const categorie = new Set();

      prodotti.forEach(p => {
        if (p.categoria) categorie.add(p.categoria);
      });

      // svuota tranne "Tutte le categorie"
      select.querySelectorAll("option:not(:first-child)").forEach(o => o.remove());

      [...categorie].sort().forEach(cat => {
        const opt = document.createElement("option");
        opt.value = cat;
        opt.textContent = cat;
        select.appendChild(opt);
      });
    }

    function renderFiltrato() {
      const search = document.getElementById("search").value.toLowerCase().trim();
      const cat = document.getElementById("filter-category").value;
      const min = parseFloat(document.getElementById("price-min").value.replace(",", "."));
      const max = parseFloat(document.getElementById("price-max").value.replace(",", "."));

      const filtrati = prodotti.filter(p => {
        if (search && !p.titolo.toLowerCase().includes(search)) return false;
        if (cat && p.categoria !== cat) return false;

        if (!isNaN(min) && p.prezzo !== null && p.prezzo < min) return false;
        if (!isNaN(max) && p.prezzo !== null && p.prezzo > max) return false;

        return true;
      });

      renderProdotti(filtrati);
      const status = document.getElementById("icc-status");
      status.textContent = `Prodotti mostrati: ${filtrati.length} / ${prodotti.length}`;
    }

    function renderProdotti(lista) {
      const grid = document.getElementById("product-grid");
      grid.innerHTML = "";

      lista.forEach(p => {
        const card = document.createElement("article");
        card.className = "icc-card";

        card.innerHTML = `
          ${p.immagine ? `<div class="icc-card-thumb"><img src="${p.immagine}" alt="${p.titolo}"></div>` : ""}
          <div class="icc-card-body">
            <h3 class="icc-card-title">${p.titolo}</h3>
            ${p.categoria ? `<p class="icc-card-category">${p.categoria}</p>` : ""}
            ${p.descrizione ? `<p class="icc-card-desc">${p.descrizione}</p>` : ""}
            <div class="icc-card-footer">
              ${
                p.prezzo !== null
                  ? `<span class="icc-card-price">${p.prezzo.toFixed(2)} â‚¬</span>`
                  : `<span class="icc-card-price icc-card-price--na">Prezzo da verificare</span>`
              }
              <a href="${p.link}" target="_blank" rel="noopener" class="icc-btn primary small">
                Vedi su Amazon
              </a>
            </div>
          </div>
        `;
        grid.appendChild(card);
      });
    }

    // Parser CSV semplice che gestisce virgolette e virgole
    function parseCsv(text) {
      const lines = text.replace(/\r/g, "").split("\n").filter(Boolean);
      return lines.map(line => {
        const cells = [];
        let current = "";
        let inQuotes = false;

        for (let i = 0; i < line.length; i++) {
          const char = line[i];

          if (char === '"') {
            if (inQuotes && line[i + 1] === '"') {
              current += '"';
              i++;
            } else {
              inQuotes = !inQuotes;
            }
          } else if (char === "," && !inQuotes) {
            cells.push(current);
            current = "";
          } else {
            current += char;
          }
        }

        cells.push(current);
        return cells;
      });
    }
  </script>
</body>
</html>
