<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Il Consiglio del Compratore</title>
  <style>
    body { font-family: system-ui, sans-serif; background:#fafafa; margin:0; }
    .wrap { max-width:1100px; margin:0 auto; padding:32px 16px; }
    h1 { text-align:center; margin-bottom:6px; }
    p.sub { text-align:center; color:#555; margin-top:0; margin-bottom:24px; }
    .grid { display:grid; gap:18px; grid-template-columns:1fr; }
    @media(min-width:768px){ .grid{ grid-template-columns:repeat(3,1fr);} }
    .card{
      background:#fff;
      border:1px solid #ddd;
      border-radius:14px;
      padding:14px;
      box-shadow:0 4px 10px rgba(0,0,0,0.04);
      text-align:center;
    }
    .card img{
      width:100%;
      height:150px;
      object-fit:cover;
      border-radius:10px;
    }
    .btn{
      background:#0066c0;
      color:#fff;
      padding:7px 14px;
      border-radius:8px;
      text-decoration:none;
      display:inline-block;
      margin-top:8px;
      font-size:0.9em;
    }
    .error { text-align:center; color:#c00; margin-top:20px; }
    .debug { font-size:0.8em; color:#777; text-align:center; margin-top:10px; white-space:pre-wrap; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Il Consiglio del Compratore</h1>
    <p class="sub">Prodotti caricati dal mio foglio Google in automatico.</p>
    <div id="prodotti" class="grid"></div>
    <div id="errore" class="error"></div>
    <div id="debug" class="debug"></div>
  </div>

  <script>
  // URL CSV pubblico del tuo Google Sheet
  const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTZ7vqus97NYfJoXjHjjI6705eGKxtqWSUWiHI5vT-xPNNghy3Ie2IaQ2MQDZI53Q7dEYzPVHbeIGR9/pub?output=csv";

  async function caricaProdotti() {
    const errBox   = document.getElementById("errore");
    const container = document.getElementById("prodotti");
    const debugBox  = document.getElementById("debug");

    if (errBox)   errBox.textContent = "";
    if (debugBox) debugBox.textContent = "";

    try {
      // aggiungo t= per evitare cache
      const res = await fetch(CSV_URL + (CSV_URL.includes("?") ? "&" : "?") + "t=" + Date.now());
      if (!res.ok) throw new Error("HTTP " + res.status);

      const text = await res.text();
      const righeRaw = text.trim().split(/\r?\n/);

      if (debugBox) debugBox.textContent = "Righe CSV: " + righeRaw.length;

      if (righeRaw.length <= 1) {
        if (errBox) errBox.textContent = "Nessun prodotto nel foglio. Aggiungi righe sotto le intestazioni.";
        return;
      }

      // header
      const headerLine = righeRaw.shift();
      const delimiter = headerLine.includes(";") ? ";" : ",";
      const headers = headerLine.split(delimiter).map(h => h.trim().toLowerCase());

      const idxTitle = headers.indexOf("titolo");
      const idxDesc  = headers.indexOf("descrizione");
      const idxImg   = headers.indexOf("immagine");
      const idxLink  = headers.indexOf("link");

      if (idxTitle === -1 || idxLink === -1) {
        if (errBox) errBox.textContent = "Intestazioni errate. Devono essere: asin, titolo, descrizione, immagine, link.";
        if (debugBox) debugBox.textContent += "\nHeader letti: " + headers.join(" | ");
        return;
      }

      container.innerHTML = "";
      let count = 0;

      righeRaw.forEach(riga => {
        if (!riga.trim()) return;
        const cols = riga.split(delimiter);

        const titolo = (cols[idxTitle] || "").trim();
        const desc   = (cols[idxDesc]  || "").trim();
        const img    = (cols[idxImg]   || "").trim();
        const link   = (cols[idxLink]  || "").trim();

        if (!titolo || !link) return;

        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `
          ${img ? `<img src="${img}" alt="${titolo}">` : ""}
          <h3>${titolo}</h3>
          <p>${desc || ""}</p>
          <a class="btn" href="${link}" target="_blank" rel="noopener">Vedi su Amazon</a>
        `;
        container.appendChild(card);
        count++;
      });

      if (count === 0 && errBox) {
        errBox.textContent = "Nessun prodotto valido generato. Controlla che ogni riga abbia almeno titolo e link.";
      } else if (debugBox) {
        debugBox.textContent += "\nProdotti generati: " + count;
      }
    } catch (e) {
      console.error(e);
      if (errBox) {
        errBox.textContent = "Errore durante il caricamento del CSV. Controlla l'URL pubblicato o riprova.";
      }
    }
  }

  caricaProdotti();
</script>
</body>
</html>
